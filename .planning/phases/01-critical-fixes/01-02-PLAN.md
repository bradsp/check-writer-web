# Phase 1, Plan 2: Number-to-Words Conversion Fix

## Objective

Fix critical bugs in the number-to-words conversion function that could cause financial disputes and incorrect check printing. The current implementation has incorrect logic for handling hundreds ("and" placement) and improper rounding for decimal values.

This fix ensures accurate conversion of numeric amounts to written form on checks, which is legally required and prevents financial errors.

## Context

Current issues (from audit):
- Hundreds incorrectly formatted (missing "and" between hundreds and remainder)
- Decimal handling has rounding errors
- No input validation (accepts NaN, negatives, over-limit amounts)
- No test coverage
- formatCurrency function exists but is unused

**Source**: analysis/remediation-plan.md (Fix 1.2)
**Priority**: CRITICAL - Financial accuracy
**Effort**: Medium

Files to examine:
- @src/utils/numberToWords.ts (current buggy implementation)
- @package.json (to add Vitest)

## Tasks

### Task 1: Install Vitest for unit testing
**Type**: dependency
**Action**:
1. Install Vitest:
   ```bash
   npm install --save-dev vitest
   ```
2. Add test scripts to package.json:
   ```json
   "scripts": {
     "test": "vitest",
     "test:ui": "vitest --ui",
     "test:run": "vitest run"
   }
   ```

**Verify**:
- [ ] Vitest appears in package.json devDependencies
- [ ] Test scripts added to package.json
- [ ] `npm test` command works (even if no tests exist yet)

**Done**: ☐

---

### Task 2: Rewrite numberToWords function with correct logic
**Type**: modify
**Files**: src/utils/numberToWords.ts
**Action**:
1. **Add input validation**:
   - Throw error if not a number or NaN
   - Throw error if negative (not allowed on checks)
   - Throw error if exceeds 999999.99 (max check amount)

2. **Fix floating point precision**:
   - Round to 2 decimal places: `num = Math.round(num * 100) / 100`

3. **Fix hundreds conversion** (critical bug fix):
   - Current: `'hundred' + (remainder ? ' ' + convert(remainder) : '')`
   - Fixed: `'hundred' + (remainder ? ' and ' + convert(remainder) : '')`
   - This adds "and" between hundreds and remainder (e.g., "One hundred and twenty")

4. **Fix zero handling**:
   - Return `'Zero and 00/100 Dollars'` for 0

5. **Fix cents calculation**:
   - Use `Math.round((num - wholeNum) * 100)` to avoid floating point errors
   - Always pad to 2 digits: `cents.toString().padStart(2, '0')`

6. **Fix capitalization**:
   - Capitalize first letter of result

7. **Fix millions handling**:
   - Ensure millions are converted correctly
   - Handle thousands remainder properly

**Implementation**:
```typescript
export function numberToWords(num: number): string {
  // Validate input
  if (typeof num !== 'number' || isNaN(num)) {
    throw new Error('Input must be a valid number');
  }
  if (num < 0) {
    throw new Error('Negative amounts are not allowed on checks');
  }
  if (num > 999999.99) {
    throw new Error('Amount exceeds maximum check value');
  }

  // Round to 2 decimal places to avoid floating point issues
  num = Math.round(num * 100) / 100;

  const ones = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine',
    'ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen',
    'seventeen', 'eighteen', 'nineteen'];
  const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];

  const convertLessThanOneThousand = (num: number): string => {
    if (num === 0) return '';
    if (num < 20) return ones[num];

    const digit = num % 10;
    if (num < 100) {
      return tens[Math.floor(num / 10)] + (digit !== 0 ? '-' + ones[digit] : '');
    }

    const remainder = num % 100;
    return ones[Math.floor(num / 100)] + ' hundred' +
           (remainder !== 0 ? ' and ' + convertLessThanOneThousand(remainder) : '');
  };

  if (num === 0) return 'Zero and 00/100 Dollars';

  // Split whole and cents
  const wholeNum = Math.floor(num);
  const cents = Math.round((num - wholeNum) * 100);

  let result = '';

  if (wholeNum >= 1000000) {
    result += convertLessThanOneThousand(Math.floor(wholeNum / 1000000)) + ' million ';
  }

  if (wholeNum >= 1000) {
    const thousands = Math.floor((wholeNum % 1000000) / 1000);
    if (thousands > 0) {
      result += convertLessThanOneThousand(thousands) + ' thousand ';
    }
  }

  const remainder = wholeNum % 1000;
  if (remainder > 0) {
    result += convertLessThanOneThousand(remainder);
  }

  // Capitalize first letter
  result = result.trim();
  result = result.charAt(0).toUpperCase() + result.slice(1);

  // Add cents
  const centsStr = cents.toString().padStart(2, '0');
  result += ` and ${centsStr}/100 Dollars`;

  return result;
}
```

**Verify**:
- [ ] Function validates input properly
- [ ] Hundreds include "and" (e.g., "One hundred and twenty")
- [ ] Cents always formatted as XX/100
- [ ] Zero returns "Zero and 00/100 Dollars"
- [ ] No TypeScript errors

**Done**: ☐

---

### Task 3: Create comprehensive test suite
**Type**: new-file
**Files**: src/utils/numberToWords.test.ts
**Action**:
Create test file with comprehensive test cases:

```typescript
import { describe, it, expect } from 'vitest';
import { numberToWords } from './numberToWords';

describe('numberToWords', () => {
  it('handles zero', () => {
    expect(numberToWords(0)).toBe('Zero and 00/100 Dollars');
  });

  it('handles ones', () => {
    expect(numberToWords(1)).toBe('One and 00/100 Dollars');
    expect(numberToWords(9)).toBe('Nine and 00/100 Dollars');
  });

  it('handles teens', () => {
    expect(numberToWords(10)).toBe('Ten and 00/100 Dollars');
    expect(numberToWords(15)).toBe('Fifteen and 00/100 Dollars');
    expect(numberToWords(19)).toBe('Nineteen and 00/100 Dollars');
  });

  it('handles tens', () => {
    expect(numberToWords(20)).toBe('Twenty and 00/100 Dollars');
    expect(numberToWords(99)).toBe('Ninety-nine and 00/100 Dollars');
  });

  it('handles hundreds with "and"', () => {
    expect(numberToWords(100)).toBe('One hundred and 00/100 Dollars');
    expect(numberToWords(102)).toBe('One hundred and two and 00/100 Dollars');
    expect(numberToWords(120)).toBe('One hundred and twenty and 00/100 Dollars');
  });

  it('handles thousands', () => {
    expect(numberToWords(1000)).toBe('One thousand and 00/100 Dollars');
    expect(numberToWords(1234.56)).toBe('One thousand two hundred and thirty-four and 56/100 Dollars');
  });

  it('handles cents correctly', () => {
    expect(numberToWords(0.01)).toBe('Zero and 01/100 Dollars');
    expect(numberToWords(0.99)).toBe('Zero and 99/100 Dollars');
    expect(numberToWords(100.50)).toBe('One hundred and 50/100 Dollars');
  });

  it('rejects negative numbers', () => {
    expect(() => numberToWords(-1)).toThrow('Negative amounts are not allowed');
  });

  it('rejects amounts over limit', () => {
    expect(() => numberToWords(10000000)).toThrow('Amount exceeds maximum');
  });

  it('rejects NaN', () => {
    expect(() => numberToWords(NaN)).toThrow('Input must be a valid number');
  });

  it('handles floating point precision', () => {
    expect(numberToWords(0.1 + 0.2)).toBe('Zero and 30/100 Dollars');
  });

  it('handles large amounts', () => {
    expect(numberToWords(999999.99)).toBe('Nine hundred and ninety-nine thousand nine hundred and ninety-nine and 99/100 Dollars');
  });
});
```

**Verify**:
- [ ] Test file created at src/utils/numberToWords.test.ts
- [ ] All test cases included
- [ ] Tests import correctly

**Done**: ☐

---

### Task 4: Run tests and verify all pass
**Type**: testing
**Action**:
1. Run test suite:
   ```bash
   npm test numberToWords
   ```
2. Verify 100% pass rate (15/15 tests passing)
3. If any tests fail, fix the implementation

**Verify**:
- [ ] All 15 tests pass
- [ ] No test failures or errors
- [ ] Test output shows green checkmarks

**Done**: ☐

---

### Task 5: Manual verification with actual checks
**Type**: testing
**Action**:
Test the following amounts by printing actual checks:

1. **Zero**: 0 → "Zero and 00/100 Dollars"
2. **Pennies**: 0.01 → "Zero and 01/100 Dollars"
3. **Simple**: 100 → "One hundred and 00/100 Dollars"
4. **With cents**: 100.50 → "One hundred and 50/100 Dollars"
5. **Complex**: 1234.56 → "One thousand two hundred and thirty-four and 56/100 Dollars"
6. **Large**: 999999.99 → "Nine hundred and ninety-nine thousand nine hundred and ninety-nine and 99/100 Dollars"

**Verify**:
- [ ] All amounts convert correctly
- [ ] "and" appears between hundreds and remainder
- [ ] Cents always show as XX/100 format
- [ ] First letter capitalized
- [ ] Text fits on check without truncation

**Done**: ☐

---

### Task 6: Remove unused formatCurrency export
**Type**: modify
**Files**: src/utils/numberToWords.ts
**Action**:
1. Remove the unused `formatCurrency` function (if it exists)
2. Or keep it if it's used elsewhere in the codebase (check with grep first)

**Verify**:
- [ ] Unused code removed or confirmed as used
- [ ] No broken imports

**Done**: ☐

## Verification

Before declaring this plan complete, verify:

1. **Tests**:
   - [ ] All unit tests pass (15/15)
   - [ ] Test coverage includes edge cases
   - [ ] Vitest configured and working

2. **Accuracy**:
   - [ ] Manual tests show correct conversion
   - [ ] "and" appears in correct places
   - [ ] Cents always formatted as XX/100
   - [ ] Large amounts convert correctly

3. **Error Handling**:
   - [ ] NaN throws error
   - [ ] Negative numbers throw error
   - [ ] Over-limit amounts throw error

4. **Code Quality**:
   - [ ] No TypeScript errors
   - [ ] Code is readable and well-structured
   - [ ] No unused code

## Success Criteria

- [ ] Vitest installed and configured
- [ ] Test scripts added to package.json
- [ ] numberToWords function rewritten with correct logic
- [ ] Comprehensive test suite created (15+ tests)
- [ ] All tests pass (100% pass rate)
- [ ] Manual verification confirms accuracy
- [ ] Hundreds include "and" (critical bug fixed)
- [ ] Cents handling fixed (no floating point errors)
- [ ] Input validation prevents invalid amounts
- [ ] No TypeScript compilation errors

## Output

Create `01-02-SUMMARY.md` documenting:

### What Was Done
- numberToWords.ts rewritten with correct logic
- Key bugs fixed: hundreds "and" placement, cents rounding
- Comprehensive test suite added
- Test results (X/X passing)

### Testing Results
- Unit test results (all passing)
- Manual test results with sample amounts
- Any edge cases discovered

### Deviations
- Any changes from the plan
- Auto-fix rules applied (1-5)
- Justification

### Commits
- Commit hashes
- Brief descriptions

### Next Steps
- Ready for 01-03-PLAN.md (Print Workflow & Date Handling)
