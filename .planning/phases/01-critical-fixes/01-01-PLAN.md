# Phase 1, Plan 1: Input Validation & Sanitization

## Objective

Implement comprehensive input validation and sanitization to protect against XSS attacks and ensure data integrity in the check writer application. This addresses a **critical security vulnerability** where user input is rendered without sanitization, creating XSS risks.

This fix prevents malicious code injection and ensures all check data is properly validated before processing and printing.

## Context

Current state (from audit findings):
- All user inputs (payee, address, city, state, zip, memo) are rendered directly without sanitization
- No XSS protection beyond React's built-in escaping
- Amount validation uses basic regex without range checks
- Date input accepts invalid dates (e.g., "2025-13-45")
- No maximum length enforcement on text fields

**Source**: analysis/remediation-plan.md (Fix 1.1)
**Priority**: CRITICAL - Security vulnerability
**Effort**: Large

Files to examine:
- @src/components/CheckForm.tsx (current validation logic)
- @src/components/CheckPreview.tsx (where data is rendered)
- @src/pages/Index.tsx (validation in onBeforePrint)
- @package.json (to add DOMPurify)

## Tasks

### Task 1: Install DOMPurify for sanitization
**Type**: dependency
**Action**:
1. Install DOMPurify and its types:
   ```bash
   npm install dompurify
   npm install --save-dev @types/dompurify
   ```
2. Verify installation in package.json

**Verify**:
- [ ] DOMPurify appears in package.json dependencies
- [ ] @types/dompurify appears in devDependencies
- [ ] `npm list dompurify` shows package installed

**Done**: ☐

---

### Task 2: Create validation utility module
**Type**: new-file
**Files**: src/utils/validation.ts
**Action**:
Create comprehensive validation utility with:

1. **Validation rules constants**:
   - PAYEE_MAX_LENGTH: 150
   - ADDRESS_MAX_LENGTH: 200
   - CITY_MAX_LENGTH: 50
   - STATE_MAX_LENGTH: 2
   - ZIP_MAX_LENGTH: 10
   - MEMO_MAX_LENGTH: 100
   - AMOUNT_MAX: 999999.99
   - AMOUNT_MIN: 0.01

2. **sanitizeText function**:
   - Use DOMPurify.sanitize() with ALLOWED_TAGS: []
   - Strip all HTML tags and encode special characters
   - Return sanitized string

3. **validateAmount function**:
   - Trim input
   - Reject empty strings
   - Validate format: digits with optional decimal (up to 2 places)
   - Parse and check range (0.01 to 999999.99)
   - Return {isValid, error?, normalized?}
   - Normalize valid amounts to 2 decimal places

4. **validateDate function**:
   - Reject empty strings
   - Check for valid date object
   - Enforce range: within 1 year past/future from today
   - Return {isValid, error?}

5. **validatePayee function**:
   - Trim input
   - Reject empty strings
   - Check max length
   - Reject suspicious patterns: <script, javascript:, onerror=
   - Return {isValid, error?}

**Verify**:
- [ ] File created at src/utils/validation.ts
- [ ] All validation functions exported
- [ ] VALIDATION_RULES constant exported
- [ ] TypeScript types properly defined
- [ ] No compilation errors

**Done**: ☐

---

### Task 3: Update CheckForm component with validation
**Type**: modify
**Files**: src/components/CheckForm.tsx
**Action**:
1. Import validation utilities from @/utils/validation
2. Add maxLength attributes to all input elements:
   - payee: VALIDATION_RULES.PAYEE_MAX_LENGTH
   - address: VALIDATION_RULES.ADDRESS_MAX_LENGTH
   - city: VALIDATION_RULES.CITY_MAX_LENGTH
   - state: VALIDATION_RULES.STATE_MAX_LENGTH
   - zipCode: VALIDATION_RULES.ZIP_MAX_LENGTH
   - memo: VALIDATION_RULES.MEMO_MAX_LENGTH

3. Update handleAmountChange:
   - Use validateAmount() instead of regex
   - Show validation error if invalid
   - Only update state with normalized valid amounts

4. Sanitize all text inputs:
   - Wrap all setPayee/setAddress/setCity/setState/setZipCode/setMemo calls with sanitizeText()
   - Example: `setPayee(sanitizeText(e.target.value))`

5. Update validateForm():
   - Use validatePayee() for payee validation
   - Use validateAmount() for amount validation
   - Use validateDate() for date validation
   - Display specific error messages from validation results

**Verify**:
- [ ] All inputs have maxLength attributes
- [ ] Amount validation uses validateAmount()
- [ ] All text inputs sanitized on change
- [ ] Validation shows specific error messages
- [ ] Form prevents submission if validation fails
- [ ] No TypeScript errors

**Done**: ☐

---

### Task 4: Update Index.tsx pre-print validation
**Type**: modify
**Files**: src/pages/Index.tsx
**Action**:
1. Import validation utilities
2. Update onBeforePrint validation:
   - Use validateDate(date)
   - Use validatePayee(payee)
   - Use validateAmount(amount)
3. Display specific error messages from validation results
4. Reject print if any validation fails

**Verify**:
- [ ] onBeforePrint uses validation utilities
- [ ] Specific error messages shown for each field
- [ ] Print prevented if validation fails
- [ ] Toast shows which field failed validation

**Done**: ☐

---

### Task 5: Update CheckPreview to use sanitized data
**Type**: modify
**Files**: src/components/CheckPreview.tsx
**Action**:
1. Import sanitizeText from validation utils
2. Sanitize all rendered text (defense in depth):
   - payee
   - address
   - city
   - state
   - zipCode
   - memo
3. Ensure formattedAmount and formattedDate remain as-is (already safe)

**Verify**:
- [ ] All user-provided text sanitized before rendering
- [ ] Preview displays correctly with sanitized data
- [ ] Print output shows sanitized data
- [ ] No visual regressions

**Done**: ☐

---

### Task 6: Test XSS protection and validation
**Type**: testing
**Action**:
Manually test the following scenarios:

**XSS Tests**:
1. Payee: `<script>alert('XSS')</script>` → Should be sanitized
2. Payee: `<img src=x onerror=alert(1)>` → Should be sanitized
3. Memo: `javascript:alert(document.cookie)` → Should be sanitized
4. Address: `<iframe src="evil.com"></iframe>` → Should be sanitized

**Amount Tests**:
5. Amount: empty → Should show error
6. Amount: `abc` → Should show error
7. Amount: `0` → Should show error (below minimum)
8. Amount: `0.001` → Should normalize to `0.00` or reject
9. Amount: `999999999` → Should show error (exceeds maximum)
10. Amount: `-100` → Should show error or be rejected
11. Amount: `100.` → Should normalize to `100.00`
12. Amount: `.50` → Should show error (invalid format)
13. Amount: `1234.56` → Should accept and normalize

**Date Tests**:
14. Date: empty → Should show error
15. Date: `2020-02-30` → Should show error (invalid date)
16. Date: `invalid` → Should show error
17. Date: 2 years ago → Should show error (out of range)
18. Date: 2 years future → Should show error (out of range)
19. Date: today → Should accept

**Length Tests**:
20. Payee: 200 characters → Should be truncated at 150
21. Address: 300 characters → Should be truncated at 200
22. Memo: 200 characters → Should be truncated at 100

**Special Characters**:
23. Payee: `O'Brien & Sons` → Should accept
24. Address: `123 "Main" Street` → Should accept
25. Memo: `Invoice #1234` → Should accept

**Verify**:
- [ ] All XSS attempts sanitized
- [ ] All invalid amounts rejected with clear errors
- [ ] All invalid dates rejected with clear errors
- [ ] Max lengths enforced
- [ ] Special characters handled correctly
- [ ] Error messages are clear and actionable

**Done**: ☐

## Verification

Before declaring this plan complete, verify:

1. **Security**:
   - [ ] DOMPurify installed and configured
   - [ ] All user inputs sanitized before rendering
   - [ ] XSS test attempts successfully blocked
   - [ ] No console errors or warnings

2. **Validation**:
   - [ ] Amount validation enforces min/max ranges
   - [ ] Date validation enforces reasonable range
   - [ ] Payee validation rejects suspicious patterns
   - [ ] All validation provides clear error messages

3. **User Experience**:
   - [ ] MaxLength prevents typing beyond limits
   - [ ] Error messages are field-specific
   - [ ] Valid inputs work as expected
   - [ ] No regressions in existing functionality

4. **Code Quality**:
   - [ ] No TypeScript errors
   - [ ] Validation logic centralized in utils/validation.ts
   - [ ] No code duplication
   - [ ] Clean imports and exports

## Success Criteria

- [ ] DOMPurify dependency added to package.json
- [ ] src/utils/validation.ts created with all validation functions
- [ ] CheckForm.tsx updated with sanitization and validation
- [ ] Index.tsx onBeforePrint uses validation utilities
- [ ] CheckPreview.tsx sanitizes all user data
- [ ] All manual tests pass successfully
- [ ] No XSS vulnerabilities remain
- [ ] All inputs properly validated with clear error messages
- [ ] No TypeScript compilation errors
- [ ] Application runs without console errors

## Output

Create `01-01-SUMMARY.md` documenting:

### What Was Done
- List of files created/modified
- Dependencies added
- Validation rules implemented

### Testing Results
- XSS test results (all blocked)
- Validation test results (edge cases handled)
- Any issues discovered during testing

### Deviations
- Any deviations from the plan
- Which auto-fix rule applied (1-5)
- Justification for changes

### Commits
- List of commit hashes
- Brief description of each commit

### Next Steps
- Ready to proceed to 01-02-PLAN.md (Number-to-Words Conversion)
