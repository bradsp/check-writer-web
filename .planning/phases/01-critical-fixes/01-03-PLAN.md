# Phase 1, Plan 3: Print Workflow & Date Handling

## Objective

Fix two critical issues: (1) race condition in print workflow using setTimeout hack, and (2) invalid date handling and timezone issues. These fixes ensure reliable printing and accurate date representation on checks.

The setTimeout hack creates a race condition where printing may occur before state updates complete. The date handling issues allow invalid dates and have timezone inconsistencies.

## Context

Current issues (from audit):
- **Race condition**: Line 79-80 uses setTimeout(500ms) to wait for state updates before printing
- **Invalid dates**: Browser accepts dates like "2025-13-45" without validation
- **Timezone bugs**: `new Date().toISOString()` uses UTC, causing date mismatches
- **Inconsistent formatting**: Date formatting scattered across components

**Source**: analysis/remediation-plan.md (Fix 1.3, Fix 1.4)
**Priority**: CRITICAL - Print reliability and data accuracy
**Effort**: Small-Medium

Files to examine:
- @src/pages/Index.tsx (setTimeout hack, date initialization)
- @src/components/CheckPreview.tsx (date formatting)
- @src/components/CheckForm.tsx (date initialization)

## Tasks

### Task 1: Replace setTimeout with useEffect
**Type**: modify
**Files**: src/pages/Index.tsx
**Action**:
1. Add useEffect to imports:
   ```typescript
   import React, { useState, useRef, useEffect } from 'react';
   ```

2. Add state for print trigger:
   ```typescript
   const [shouldPrint, setShouldPrint] = useState(false);
   ```

3. Add useEffect to handle printing:
   ```typescript
   useEffect(() => {
     if (shouldPrint && showPreview) {
       // State has been updated, trigger print
       handlePrint();
       setShouldPrint(false);
     }
   }, [shouldPrint, showPreview]);
   ```

4. Update handleFormSubmit (remove setTimeout):
   ```typescript
   const handleFormSubmit = (formData: CheckFormData) => {
     // Update state with form data
     setDate(formData.date);
     setPayee(formData.payee);
     setAddress(formData.address);
     setCity(formData.city);
     setState(formData.state);
     setZipCode(formData.zipCode);
     setAmount(formData.amount);
     setMemo(formData.memo);

     // Show preview
     setShowPreview(true);

     // Trigger print on next render (via useEffect)
     setShouldPrint(true);
   };
   ```

**Verify**:
- [ ] setTimeout removed completely
- [ ] useEffect handles print trigger
- [ ] Print occurs after state updates complete
- [ ] No race conditions

**Done**: ☐

---

### Task 2: Create date utility module
**Type**: new-file
**Files**: src/utils/dateHelpers.ts
**Action**:
Create date utility with timezone-safe functions:

```typescript
import { format, isValid, parseISO } from 'date-fns';

/**
 * Get today's date in local timezone as ISO string (YYYY-MM-DD)
 * Avoids UTC conversion issues from Date.toISOString()
 */
export function getTodayLocalISO(): string {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

/**
 * Format ISO date string for check printing (MM/DD/YYYY)
 * Handles invalid dates gracefully
 */
export function formatCheckDate(isoDateString: string): string {
  try {
    const date = parseISO(isoDateString);
    if (!isValid(date)) {
      throw new Error('Invalid date');
    }
    // Use consistent MM/DD/YYYY format
    return format(date, 'MM/dd/yyyy');
  } catch (error) {
    console.error('Date formatting error:', error);
    return 'Invalid Date';
  }
}

/**
 * Validate that a date string is valid
 */
export function isValidCheckDate(isoDateString: string): boolean {
  try {
    const date = parseISO(isoDateString);
    return isValid(date);
  } catch {
    return false;
  }
}
```

**Verify**:
- [ ] File created at src/utils/dateHelpers.ts
- [ ] All functions exported
- [ ] TypeScript types correct
- [ ] date-fns imported

**Done**: ☐

---

### Task 3: Update Index.tsx to use date helpers
**Type**: modify
**Files**: src/pages/Index.tsx
**Action**:
1. Import date helpers:
   ```typescript
   import { getTodayLocalISO } from '@/utils/dateHelpers';
   ```

2. Replace line 21:
   - OLD: `const [date, setDate] = useState<string>(new Date().toISOString().split('T')[0]);`
   - NEW: `const [date, setDate] = useState<string>(getTodayLocalISO());`

**Verify**:
- [ ] getTodayLocalISO() used for initial date
- [ ] Date matches local timezone (not UTC)
- [ ] No more toISOString().split() hack

**Done**: ☐

---

### Task 4: Update CheckForm to use date helpers
**Type**: modify
**Files**: src/components/CheckForm.tsx
**Action**:
1. Import date helpers:
   ```typescript
   import { getTodayLocalISO } from '@/utils/dateHelpers';
   ```

2. Replace line 28:
   - OLD: `const [date, setDate] = useState<string>(initialValues.date || new Date().toISOString().split('T')[0]);`
   - NEW: `const [date, setDate] = useState<string>(initialValues.date || getTodayLocalISO());`

3. Replace line 120:
   - OLD: `setDate(new Date().toISOString().split('T')[0]);`
   - NEW: `setDate(getTodayLocalISO());`

**Verify**:
- [ ] getTodayLocalISO() used in both places
- [ ] Form initializes with correct local date
- [ ] Clear button resets to today's local date

**Done**: ☐

---

### Task 5: Update CheckPreview to use date formatter
**Type**: modify
**Files**: src/components/CheckPreview.tsx
**Action**:
1. Import date formatter:
   ```typescript
   import { formatCheckDate } from '@/utils/dateHelpers';
   ```

2. Replace line 19:
   - OLD: `const formattedDate = date ? new Date(date).toLocaleDateString('en-US') : '';`
   - NEW: `const formattedDate = formatCheckDate(date);`

3. Add error handling for "Invalid Date":
   ```typescript
   {formattedDate === 'Invalid Date' ? (
     <span className="text-red-500">Invalid Date</span>
   ) : (
     formattedDate
   )}
   ```

**Verify**:
- [ ] formatCheckDate() used for all date displays
- [ ] Invalid dates show error instead of crashing
- [ ] Date format is consistent (MM/DD/YYYY)
- [ ] Preview and print show same formatted date

**Done**: ☐

---

### Task 6: Ensure date-fns is installed
**Type**: dependency
**Action**:
1. Check if date-fns is installed:
   ```bash
   npm list date-fns
   ```

2. If not installed:
   ```bash
   npm install date-fns
   ```

**Verify**:
- [ ] date-fns appears in package.json
- [ ] No installation errors

**Done**: ☐

---

### Task 7: Test print workflow and date handling
**Type**: testing
**Action**:
**Print Workflow Tests**:
1. Click "Print Check" and verify print dialog appears immediately
2. Verify all check data is populated correctly in print view
3. Double-click "Print Check" rapidly and verify no duplicate prints or errors
4. Test on slow device/throttled CPU (Chrome DevTools -> Performance -> 6x slowdown)

**Date Tests**:
5. Open app and verify default date matches today's local date (not UTC)
6. Change computer timezone and verify date still matches local date
7. Enter invalid date in date picker (if browser allows) and verify error handling
8. Test leap year: 2024-02-29 → Should format correctly
9. Test formatting: 2025-01-07 → Should display as "01/07/2025"
10. Test edge case: Try to manually input invalid date via dev tools

**Verify**:
- [ ] Print dialog appears immediately without setTimeout delay
- [ ] No race conditions (test 10+ times with rapid clicking)
- [ ] Default date matches local timezone
- [ ] Date formatting is consistent across all views
- [ ] Invalid dates handled gracefully
- [ ] No console errors

**Done**: ☐

## Verification

Before declaring this plan complete, verify:

1. **Print Workflow**:
   - [ ] setTimeout completely removed
   - [ ] useEffect handles print trigger correctly
   - [ ] No race conditions on fast or slow devices
   - [ ] Print preview and print output match

2. **Date Handling**:
   - [ ] All date operations use local timezone
   - [ ] Date formatting is consistent (MM/DD/YYYY)
   - [ ] Invalid dates handled gracefully
   - [ ] No toISOString().split() hacks remain

3. **Code Quality**:
   - [ ] date-fns utility functions centralized
   - [ ] No code duplication
   - [ ] TypeScript errors resolved
   - [ ] Clean imports

## Success Criteria

- [ ] setTimeout removed from Index.tsx
- [ ] useEffect handles print workflow
- [ ] src/utils/dateHelpers.ts created with 3 functions
- [ ] Index.tsx uses getTodayLocalISO()
- [ ] CheckForm.tsx uses getTodayLocalISO()
- [ ] CheckPreview.tsx uses formatCheckDate()
- [ ] date-fns dependency confirmed installed
- [ ] All manual tests pass
- [ ] No race conditions in print workflow
- [ ] Dates use local timezone consistently
- [ ] Invalid dates handled gracefully
- [ ] No TypeScript compilation errors

## Output

Create `01-03-SUMMARY.md` documenting:

### What Was Done
- setTimeout removed, replaced with useEffect pattern
- dateHelpers.ts utility created
- All components updated to use date helpers
- Date handling now timezone-safe

### Testing Results
- Print workflow tests (rapid clicking, slow devices)
- Date handling tests (timezones, invalid dates, formatting)
- Any issues discovered

### Deviations
- Any changes from the plan
- Auto-fix rules applied
- Justification

### Commits
- Commit hashes and descriptions

### Next Steps
- Ready for 01-04-PLAN.md (Error Handling & Security Infrastructure)
